<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoftView Web</title>
</head>
<body>
<form id="input">
    Command: <input type="text" id="text"/>
    <input type="submit"/>
</form>
<canvas id="canvas" width="400" height="300"/>
<script>
        function updateCanvas(api) {
            const w = api.SV_get_width()
            const h = api.SV_get_height()
            const p = api.SV_get_canvas()
            const data = new Uint8ClampedArray(api.memory.buffer.slice(p, p + w*h*4))
            const canvas = document.getElementById('canvas')
            const ctx = canvas.getContext('2d')
            ctx.putImageData(new ImageData(data, 400, 300), 0, 0)
        }

        const importObject = {
            env: {
            __linear_memory: new WebAssembly.Memory({ initial: 256 }),
            __stack_pointer: new WebAssembly.Global({value:'i32', mutable:true,}, 0),
            }
        };

        const api = WebAssembly.instantiateStreaming(
            fetch('SoftView-Web.wasm'),
            importObject
        ).then(result => {
            const api = result.instance.exports
            api.SV_initialize_canvas(400, 300, 0xFF333333)
            // updateCanvas(api)
            const form = document.getElementById('input')
            form.addEventListener("submit", function(event){
                event.preventDefault()
                const content = document.getElementById('text').value
                let exit = new Boolean(false);
                let buff = new Uint8Array(api.memory.buffer)

                console.log(content)
                api.SV_handle_command(new TextEncoder().encode(content), buff, exit)
                console.log(new TextDecoder().decode(buff))
                console.log(exit)

                updateCanvas(api)
            });
        });
    </script>
</body>
</html>